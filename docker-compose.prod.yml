# docker-compose.prod.yml - Production Environment
# Use: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  mgthemes_nginx:
    environment:
      - APP_ENV=production
    volumes:
      # Production: delegated mount, no unnecessary sync
      - ./src:/var/www/html:delegated
      - ./docker/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./docker/nginx/conf.d:/etc/nginx/conf.d:ro
      # SSL certificates cho production
      - ./docker/ssl:/etc/nginx/ssl:ro
    restart: always

  mgthemes_php:
    environment:
      # Production environment variables
      - APP_ENV=production
      - MAGE_MODE=production
      - PHP_MEMORY_LIMIT=2G
      - PHP_MAX_EXECUTION_TIME=18000
      - PHP_OPCACHE_ENABLE=1
      - PHP_OPCACHE_MEMORY_CONSUMPTION=512
      - PHP_OPCACHE_MAX_ACCELERATED_FILES=60000
      - PHP_OPCACHE_VALIDATE_TIMESTAMPS=0
      - PHP_REALPATH_CACHE_SIZE=10M
      - PHP_REALPATH_CACHE_TTL=7200
      - COMPOSER_MEMORY_LIMIT=-1
    volumes:
      # Production: delegated mount, optimized for performance
      - ./src:/var/www/html:delegated
      - ./docker/php/php.prod.ini:/usr/local/etc/php/php.ini:ro
      - ./docker/php/php-fpm.prod.conf:/usr/local/etc/php-fpm.d/www.conf:ro
    restart: always
    # No Xdebug in production

  mgthemes_mysql:
    environment:
      # Production database settings - use strong passwords from .env
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    # Don't expose MySQL port in production
    ports: []
    restart: always
    # Production optimized MySQL config
    command: >
      --max_connections=500
      --innodb_buffer_pool_size=2G
      --innodb_log_file_size=512M
      --innodb_flush_log_at_trx_commit=2
      --innodb_flush_method=O_DIRECT

  mgthemes_redis:
    # Don't expose Redis port in production
    ports: []
    restart: always
    command: >
      redis-server
      --appendonly yes
      --maxmemory 512mb
      --maxmemory-policy allkeys-lru

  mgthemes_opensearch:
    environment:
      - discovery.type=single-node
      - bootstrap.memory_lock=true
      - "OPENSEARCH_JAVA_OPTS=-Xms1g -Xmx1g"
      - DISABLE_SECURITY_PLUGIN=false
      - OPENSEARCH_INITIAL_ADMIN_PASSWORD=${OPENSEARCH_PASSWORD}
    # Don't expose OpenSearch ports in production
    ports: []
    restart: always

  mgthemes_phpmyadmin:
    # Disable phpMyAdmin in production or restrict access
    environment:
      - PMA_HOST=mgthemes_mysql
      - PMA_PORT=3306
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - PMA_ABSOLUTE_URI=https://mgthemes.info:8080/
    # Change port or disable in production
    ports:
      - "127.0.0.1:8080:80"
    restart: always
